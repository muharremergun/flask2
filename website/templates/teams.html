<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Teams{% endblock %}</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
    {% extends "base.html" %}

    {% block content %}
    <div class="container mt-4">
        <h1 class="text-center">My Teams</h1>
        
        <!-- Takım Seçim Formu -->
        <form method="post" action="{{ url_for('views.teams') }}">
            <div class="form-group">
                <label for="team_id">Select a Team to View Details:</label>
                <select id="team_id" name="team_id" class="form-control">
                    <option value="">-- Select a Team --</option>
                    {% for team in user_teams %}
                        <option value="{{ team.id }}" {% if team.id == (team.id if team else None) %}selected{% endif %}>
                            {{ team.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">View Team</button>
        </form>
        
        <!-- Takım Detayları ve Üyeleri -->
        {% if team %}
            <div class="mt-4">
                <h2>Team Details</h2>
                <h3>{{ team.name }}</h3>
                <h4>Members:</h4>
                <ul class="list-group">
                    {% for user in team_users[team.id] %}
                        <li class="list-group-item">
                            {{ user.first_name }} ({{ user.email }}) 
                        
                            {% if user_roles[user.id] == 'manager' %}
                             (★)
                            {% endif %}
                                    
                        </li>
                    {% else %}
                        <li class="list-group-item">No users found for this team.</li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Takım Notları -->
            <div class="mt-4">
                <h2>{{ team.name }} Notes</h2>
                <ul class="list-group list-group-flush" id="notes">
                    {% for note in notes %}
                    <li class="list-group-item {% if note.completed %}completed{% endif %}" data-note-id="{{ note.id }}">
                        <div class="note-content d-flex justify-content-between align-items-center">
                            <div class="note-text">{{ note.data }}</div>
                            <div class="button-group">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onClick="openInfoModal('{{ note.info|e }}', {{ note.id }})">
                                    <i class="fa fa-info-circle"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onClick="writeNoteText('{{ note.data|e }}', '{{ note.reminder_days }}')">
                                    <i class="fa fa-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onClick="deleteNote({{ note.id }})">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary complete-btn" onClick="toggleComplete({{ note.id }})">
                                    {% if note.completed %}
                                    <i class="fa fa-check-circle" style="color: green;"></i>
                                    {% else %}
                                    <i class="fa fa-check-circle-o" style="color: red;"></i>
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                        <div class="note-info d-flex justify-content-start align-items-center" style="color: gray;">
                            {% if note.reminder_days > 0 %}
                                {% set remaining_days = (note.reminder_date - now).days %}
                                {% if remaining_days > 0 %}
                                    <span class="mr-2">Reminder in {{ remaining_days }} days</span>
                                {% elif remaining_days == 0 %}
                                    <span class="mr-2"> Counter is 0 , fix it today!!!  </span>
                                {% else %}
                                    <span class="mr-2">{{ remaining_days|string|replace('-','') }} days overdue</span>
                                {% endif %}
                            {% elif note.reminder_days == 0 %}
                                <span class="mr-2">No reminder date set</span>
                            {% else %}
                                <span class="mr-2">No reminder set</span>
                            {% endif %}
                            <span>{{ note.date }}</span>
                        </div>
                        <div class="reminder-status"></div>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        
        <!-- Kullanıcının Tüm Takımları -->
        <div class="mt-4">
            <h2>All My Teams</h2>
            <ul class="list-group">
                {% for team in user_teams %}
                    <li class="list-group-item">
                        <form method="post" action="{{ url_for('views.teams') }}" style="display:inline;">
                            <input type="hidden" name="team_id" value="{{ team.id }}">
                            <button type="submit" class="btn btn-link">{{ team.name }}</button>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endblock %}
</body>
</html>


<script>
    var now = new Date(); // Şu anki zamanı tanımla

    // Quill Editor
    var quill = new Quill('#editor-container', {
        theme: 'snow'
    });

    // Info Modal ile ilgili fonksiyonlar
    var modal = document.getElementById("infoModal");
    var span = document.getElementsByClassName("close")[0];
    var saveBtn = document.getElementById("saveBtn");
    var currentNoteId = null; // Düzenlenen notun ID'sini saklamak için

    function openInfoModal(noteText, noteId) {
        quill.root.innerHTML = noteText;
        modal.style.display = "block";
        currentNoteId = noteId; // Düzenlenen notun ID'sini sakla
    }

    span.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    saveBtn.onclick = function() {
        var infoText = quill.root.innerHTML;
        fetch('/update_info', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ info: infoText, noteId: currentNoteId }), // Note ID'yi de gönder
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Success:', data);
                modal.style.display = "none"; // Başarılı güncellemeden sonra modalı kapat
                quill.root.innerHTML = ""; // Metin kutusunu temizle
                window.location.reload(); // Sayfayı yenileyerek güncellenen bilgileri göster
            } else {
                console.error('Error:', data.error);
                alert('Failed to update note info.'); // Hata durumunda kullanıcıya bilgi ver
            }
        })
        .catch((error) => {
            console.error('Error:', error);
            alert('Failed to update note info.'); // Hata durumunda kullanıcıya bilgi ver
        });
    }

    function writeNoteText(noteText, reminderDays) {
        document.getElementById('note').value = noteText;
        document.getElementById('reminder-days').value = reminderDays;
    }

    function toggleComplete(noteId) {
        var noteElement = document.querySelector(`#notes li[data-note-id="${noteId}"]`);
        var isCompleted = noteElement.classList.toggle('completed');
        var completeBtn = noteElement.querySelector('.complete-btn');

        // Görsel olarak tamamlanma durumunu göster
        if (isCompleted) {
            completeBtn.innerHTML = '<i class="fa fa-check-circle" style="color: green;"></i>';
        } else {
            completeBtn.innerHTML = '<i class="fa fa-check-circle-o" style="color: red;"></i>';
        }

        // Notun tamamlandı durumunu güncelle
        fetch('/toggle-completed', {
            method: 'POST',
            body: JSON.stringify({ noteId: noteId, isCompleted: isCompleted ? 1 : 0 }), // true ise 1, false ise 0 gönder
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // Başarısız durumda kullanıcıya bilgi ver
                alert('Failed to toggle completion status.');
            }
        });
    }

    function deleteNote(noteId) {
        if (confirm('Are you sure you want to delete this note?')) {
            fetch('/delete-note', {
                method: 'POST',
                body: JSON.stringify({ noteId: noteId }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Not başarıyla silindiyse, sayfayı yenile
                    window.location.reload();
                } else {
                    // Hata durumunda kullanıcıya bilgi ver
                    alert('Failed to delete note.');
                }
            });
        }
    }
</script>
